name: Markdown Linting and Auto-fix

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**/*.md'
  pull_request:
    branches: [ main ]
    paths:
      - '**/*.md'
  workflow_dispatch:

jobs:
  markdown-lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm install -g markdownlint-cli2
        npm install -g markdownlint-cli2-formatter-pretty

    - name: Run markdownlint check
      id: lint-check
      run: |
        echo "Running markdownlint check..."
        if markdownlint-cli2 "**/*.md"; then
          echo "lint-passed=true" >> $GITHUB_OUTPUT
          echo "✅ All markdown files pass linting checks!"
        else
          echo "lint-passed=false" >> $GITHUB_OUTPUT
          echo "❌ Markdown linting issues found (MD022, MD032, etc.)"
        fi
      continue-on-error: true

    - name: Auto-fix markdown issues
      if: steps.lint-check.outputs.lint-passed == 'false'
      run: |
        echo "Attempting to auto-fix markdown issues..."
        echo "Fixing MD022 (blanks around headings) and MD032 (blanks around lists)..."
        markdownlint-cli2-fix "**/*.md" || true

    - name: Check if fixes were applied
      if: steps.lint-check.outputs.lint-passed == 'false'
      id: check-changes
      run: |
        if git diff --quiet; then
          echo "changes-made=false" >> $GITHUB_OUTPUT
          echo "No automatic fixes could be applied"
        else
          echo "changes-made=true" >> $GITHUB_OUTPUT
          echo "Automatic fixes applied successfully"
          git diff --name-only
        fi

    - name: Commit and push fixes
      if: steps.check-changes.outputs.changes-made == 'true' && github.event_name == 'push'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add "**/*.md"
        git commit -m "🔧 Auto-fix markdown linting issues (MD022: headings spacing, MD032: lists spacing)"
        git push

    - name: Run final validation
      run: |
        echo "Running final validation..."
        markdownlint-cli2 "**/*.md"

    - name: Comment on PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const lintPassed = '${{ steps.lint-check.outputs.lint-passed }}';
          const changesMade = '${{ steps.check-changes.outputs.changes-made }}';
          
          let message = '## 📝 Markdown Linting Results\n\n';
          
          if (lintPassed === 'true') {
            message += '✅ All markdown files pass linting checks!\n';
            message += 'No issues found with headings spacing (MD022) or lists spacing (MD032).';
          } else if (changesMade === 'true') {
            message += '🔧 Markdown issues were found and automatically fixed:\n';
            message += '- **MD022**: Added blank lines around headings\n';
            message += '- **MD032**: Added blank lines around lists\n\n';
            message += 'Please review the changes and update your branch.';
          } else {
            message += '❌ Markdown issues were found that require manual fixing:\n';
            message += '- Check for proper spacing around headings (MD022)\n';
            message += '- Check for proper spacing around lists (MD032)\n\n';
            message += 'Please check the workflow logs for details.';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });
